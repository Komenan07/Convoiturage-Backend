<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Socket.IO</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    #logs {
      border: 1px solid #ccc;
      padding: 10px;
      height: 300px;
      overflow-y: scroll;
      margin: 20px 0;
      background-color: #f9f9f9;
    }
    button {
      padding: 8px 16px;
      margin: 5px;
      cursor: pointer;
    }
    .success {
      color: green;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <h1>Test Socket.IO</h1>
  <p>Ouvrez la console (F12) pour voir les logs détaillés.</p>
  <div>
    <h3>Actions</h3>
    <button onclick="connectSocket()">Se connecter</button>
    <button onclick="joinConversation()">Rejoindre une conversation</button>
    <button onclick="sendMessage()">Envoyer un message privé</button>
    <button onclick="createReservation()">Créer une réservation</button>
    <button onclick="joinPublicChat()">Rejoindre le chat public</button>
    <button onclick="sendPublicMessage()">Envoyer un message public</button>
    <button onclick="disconnectSocket()">Se déconnecter</button>
  </div>
  <h3>Logs</h3>
  <div id="logs"></div>
  <script>
    let socket = null;
    const logsDiv = document.getElementById('logs');

    function log(message, isError = false) {
      const logEntry = document.createElement('p');
      logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logEntry.className = isError ? 'error' : 'success';
      logsDiv.appendChild(logEntry);
      logsDiv.scrollTop = logsDiv.scrollHeight;
      console.log(message);
    }

    function connectSocket() {
      if (socket && socket.connected) {
        log('Déjà connecté !');
        return;
      }
      // Remplacez par votre token JWT valide
      const token = prompt("Entrez votre token JWT (laisser vide pour tester en anonyme) :", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI2ODlmNjE5OGU2OGQwMzRmZmY0MDM2NDIiLCJyb2xlIjoidXRpbGlzYXRldXIiLCJpYXQiOjE3NTUyNzU4NzgsImV4cCI6MTc1NTI3Njc3OH0.NDKl32X6qjbhKtXxfny3aeQlEUTB3FmCxQHe3DCIV9c");
      const options = {};
      if (token) {
        options.auth = { token };
      }
      socket = io("ws://localhost:3000", options);

      socket.on("connect", () => {
        log(`Connecté au serveur ! ID: ${socket.id}`);
      });

      socket.on("connect_error", (err) => {
        log(`Erreur de connexion: ${err.message}`, true);
      });

      socket.on("disconnect", (reason) => {
        log(`Déconnecté: ${reason}`);
      });

      // Écouter les événements de base
      socket.on("connection:ack", (data) => {
        log(`Connexion confirmée: ${JSON.stringify(data)}`);
      });

      socket.on("user_online", (data) => {
        log(`Utilisateur en ligne: ${JSON.stringify(data)}`);
      });

      socket.on("new_message", (data) => {
        log(`Nouveau message privé: ${JSON.stringify(data)}`);
      });

      socket.on("public_message", (data) => {
        log(`Message public: ${JSON.stringify(data)}`);
      });

      socket.on("reservation_created", (data) => {
        log(`Réservation créée: ${JSON.stringify(data)}`);
      });

      socket.on("user_offline", (data) => {
        log(`Utilisateur hors ligne: ${JSON.stringify(data)}`);
      });
    }

    function joinConversation() {
      if (!socket || !socket.connected) {
        log('Non connecté au serveur !', true);
        return;
      }
      const conversationId = prompt("ID de la conversation :", "60d5ec9f8b3e4b001f8e4a1b");
      if (!conversationId) {
        log('ID de conversation requis !', true);
        return;
      }
      socket.emit("conversation:join", { conversationId }, (response) => {
        if (response.success) {
          log(`Conversation rejointe: ${JSON.stringify(response)}`);
        } else {
          log(`Erreur: ${response.error}`, true);
        }
      });
    }

    function sendMessage() {
      if (!socket || !socket.connected) {
        log('Non connecté au serveur !', true);
        return;
      }
      const conversationId = prompt("ID de la conversation :", "60d5ec9f8b3e4b001f8e4a1b");
      const destinataireId = prompt("ID du destinataire :", "60d5ec9f8b3e4b001f8e4a1c");
      const contenu = prompt("Contenu du message :", "Bonjour, ceci est un test !");
      if (!conversationId || !destinataireId || !contenu) {
        log('Tous les champs sont requis !', true);
        return;
      }
      socket.emit("send_message", {
        conversationId,
        destinataireId,
        contenu,
        typeMessage: "TEXTE"
      }, (response) => {
        if (response.success) {
          log(`Message envoyé: ${JSON.stringify(response)}`);
        } else {
          log(`Erreur: ${response.error}`, true);
        }
      });
    }

    function createReservation() {
      if (!socket || !socket.connected) {
        log('Non connecté au serveur !', true);
        return;
      }
      const trajetId = prompt("ID du trajet :", "60d5ec9f8b3e4b001f8e4a1d");
      const nombrePlacesReservees = prompt("Nombre de places :", "1");
      const pointPriseEnCharge = prompt("Point de prise en charge :", "Gare d'Abidjan");
      const pointDepose = prompt("Point de dépose :", "Aéroport");
      if (!trajetId || !nombrePlacesReservees || !pointPriseEnCharge || !pointDepose) {
        log('Tous les champs sont requis !', true);
        return;
      }
      socket.emit("create_reservation", {
        trajetId,
        nombrePlacesReservees: parseInt(nombrePlacesReservees),
        pointPriseEnCharge,
        pointDepose
      }, (response) => {
        if (response.success) {
          log(`Réservation créée: ${JSON.stringify(response)}`);
        } else {
          log(`Erreur: ${response.error}`, true);
        }
      });
    }

    function joinPublicChat() {
      if (!socket || !socket.connected) {
        log('Non connecté au serveur !', true);
        return;
      }
      const roomName = prompt("Nom de la salle publique :", "general");
      socket.emit("public_chat:join", { roomName }, (response) => {
        if (response.success) {
          log(`Chat public rejoint: ${JSON.stringify(response)}`);
        } else {
          log(`Erreur: ${response.error}`, true);
        }
      });
    }

    function sendPublicMessage() {
      if (!socket || !socket.connected) {
        log('Non connecté au serveur !', true);
        return;
      }
      const roomName = prompt("Nom de la salle publique :", "general");
      const content = prompt("Contenu du message :", "Salut à tous !");
      const username = prompt("Votre pseudo (optionnel) :", "Anonyme");
      if (!content) {
        log('Contenu requis !', true);
        return;
      }
      socket.emit("send_public_message", {
        roomName,
        content,
        username
      }, (response) => {
        if (response.success) {
          log(`Message public envoyé: ${JSON.stringify(response)}`);
        } else {
          log(`Erreur: ${response.error}`, true);
        }
      });
    }

    function disconnectSocket() {
      if (!socket || !socket.connected) {
        log('Non connecté au serveur !', true);
        return;
      }
      socket.disconnect();
      log('Déconnecté du serveur.');
    }
  </script>
</body>
</html>
